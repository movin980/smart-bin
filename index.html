<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Waste Management â€” Demo</title>
  <style>
    body{ font-family: system-ui, sans-serif; margin:0; padding:0; }
    header{ display:flex; justify-content:space-between; align-items:center; padding:10px 16px; background:#222; color:#fff }
    #role-switch button{ margin-left:8px; padding:6px 10px }
    #info{ padding:12px }
    #stats{ font-weight:600; margin-bottom:8px }
    button{ padding:8px 12px; cursor:pointer }
    #alerts{ margin-top:12px; padding:10px; border:1px solid #ccc; background:#f9f9f9 }
    .alert{ padding:6px 0; border-bottom:1px solid #eee }
  </style>
</head>
<body>
  <header>
    <h1>Smart Waste Management â€” Demo</h1>
    <div id="role-switch">
      <button id="role-citizen">Citizen</button>
      <button id="role-collector">Collector</button>
    </div>
  </header>

  <main>
    <div id="map" style="height:60vh"></div>

    <section id="info">
      <div id="stats">Loading stats...</div>
      <div id="actions"><p>Click a bin on the map to interact.</p></div>
      <div id="alerts"><strong>Alerts:</strong><div id="alert-list"></div></div>
    </section>
  </main>

  <!-- FIREBASE CONFIG -->
  <script>
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyA6nAAc3sx9mkOapNSff7k1EFGkfbLN_o4",
      authDomain: "smart-bin-b826f.firebaseapp.com",
      databaseURL: "https://smart-bin-b826f-default-rtdb.firebaseio.com",
      projectId: "smart-bin-b826f",
      storageBucket: "smart-bin-b826f.firebasestorage.app",
      messagingSenderId: "339092553035",
      appId: "1:339092553035:web:9edfd5351f64d6cb563cce",
      measurementId: "G-HN2LD86VWN"
    };
  </script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- Google Maps: replace YOUR_GOOGLE_MAPS_API_KEY -->
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&callback=initApp">
  </script>

  <script>
    // Initialize Firebase
    firebase.initializeApp(FIREBASE_CONFIG);
    const db = firebase.database();

    let map;
    const markers = {};
    let role = 'citizen'; // or 'collector'

    function initApp(){
      // default center (Nairobi) â€” adjust as needed
      const center = { lat: -1.28333, lng: 36.81667 };
      map = new google.maps.Map(document.getElementById('map'), { center, zoom: 13 });

      // role buttons
      document.getElementById('role-citizen').onclick = ()=>{ role='citizen'; renderInfo(); };
      document.getElementById('role-collector').onclick = ()=>{ role='collector'; renderInfo(); };

      // Listen to bins in Firebase
      db.ref('bins').on('value', snapshot => {
        const bins = snapshot.val() || {};
        updateMarkers(bins);
        updateStats(bins);
        renderInfo();
      });
    }

    function updateMarkers(bins){
      // remove markers for deleted bins
      for(const id in markers){
        if(!bins[id]){ markers[id].setMap(null); delete markers[id]; }
      }

      for(const id in bins){
        const b = bins[id];
        if(markers[id]){
          markers[id].setPosition({lat: b.lat, lng: b.lng});
          markers[id].setIcon(iconForStatus(b.status));
        } else {
          const m = new google.maps.Marker({
            position: {lat: b.lat, lng: b.lng},
            map,
            title: `Bin ${id}`,
            icon: iconForStatus(b.status)
          });
          m.addListener('click', ()=> onMarkerClick(id, b));
          markers[id] = m;
        }
      }
    }

    function iconForStatus(status){
      const color = status === 'full' ? '#d9534f' : status === 'half' ? '#f0ad4e' : '#5cb85c';
      const svg = `data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24'><circle cx='12' cy='12' r='10' fill='${color}' /></svg>`;
      return svg;
    }

    function onMarkerClick(id, bin){
      const actions = document.getElementById('actions');
      actions.innerHTML = `<h3>Bin ${id}</h3><p>Status: ${bin.status} (${bin.level}%)</p>`;
      if(role === 'citizen'){
        const btn = document.createElement('button');
        btn.textContent = 'Report Full';
        btn.onclick = ()=> reportFull(id);
        actions.appendChild(btn);
      } else {
        const btn = document.createElement('button');
        btn.textContent = 'Mark Collected';
        btn.onclick = ()=> markCollected(id);
        actions.appendChild(btn);
      }
    }

    function reportFull(id){
      const updates = { level: 100, status: 'full', lastUpdated: Date.now() };
      db.ref('bins/' + id).update(updates);
      addAlert(`ðŸ“© Alert: Bin ${id} has been reported as FULL! Collector notified.`);
    }

    function markCollected(id){
      const updates = { level: 0, status: 'empty', lastUpdated: Date.now() };
      db.ref('bins/' + id).update(updates);
      addAlert(`âœ… Bin ${id} has been emptied and marked as collected.`);
    }

    function updateStats(bins){
      const counts = { full:0, half:0, empty:0 };
      for(const id in bins){ counts[bins[id].status] = (counts[bins[id].status]||0) + 1; }
      document.getElementById('stats').innerHTML = `Full: ${counts.full} | Half: ${counts.half} | Empty: ${counts.empty}`;
    }

    function renderInfo(){
      if(!document.getElementById('actions').innerHTML) {
        document.getElementById('actions').innerHTML = '<p>Click a bin on the map to interact.</p>';
      }
    }

    function addAlert(message){
      const container = document.getElementById('alert-list');
      const div = document.createElement('div');
      div.className = 'alert';
      div.textContent = message;
      container.prepend(div);
    }

    window.initApp = initApp;
  </script>
</body>
</html>
