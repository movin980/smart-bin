<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lost & Found</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; padding:20px; }
    .container { max-width:800px; margin:auto; background:#fff; padding:20px; border-radius:10px; }
    form { margin-bottom:30px; }
    input, textarea, select, button {
      display:block; width:100%; padding:10px; margin:10px 0;
    }
    .items { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
    .item { border:1px solid #ddd; padding:10px; border-radius:8px; background:#fafafa; }
    .item img { max-width:100%; border-radius:6px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Lost & Found Report</h2>
    <form id="reportForm">
      <select id="type">
        <option value="lost">Lost</option>
        <option value="found">Found</option>
      </select>
      <input type="text" id="itemName" placeholder="Item name" required />
      <textarea id="description" placeholder="Description"></textarea>
      <input type="text" id="location" placeholder="Location" />
      <input type="date" id="date" />
      <input type="text" id="contact" placeholder="Your contact info" required />
      <input type="file" id="photo" accept="image/*" />
      <button type="submit">Submit Report</button>
      <p id="formMsg"></p>
    </form>

    <h2>Reports</h2>
    <div class="items" id="itemsContainer"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <script>
    // ðŸ”¹ Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD-pD4TfRvBzKlZnK7GqW7NG69V-8Or3Rw",
      authDomain: "smartwatertank-292e9.firebaseapp.com",
      databaseURL: "https://smartwatertank-292e9-default-rtdb.firebaseio.com",
      projectId: "smartwatertank-292e9",
      storageBucket: "smartwatertank-292e9.appspot.com",
      messagingSenderId: "684207674457",
      appId: "1:684207674457:web:7e0dc2d5a7d3e3a8d9c6c1"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    const reportForm = document.getElementById('reportForm');
    const formMsg = document.getElementById('formMsg');
    const itemsContainer = document.getElementById('itemsContainer');

    // ðŸ”¹ Safe compression with fallback
    function compressIfNeeded(file, maxW=1200, maxH=1200, quality=0.7) {
      return new Promise((resolve) => {
        if (file.size && file.size < 500 * 1024) return resolve(file);

        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            let { width, height } = img;
            if (width > maxW) { height *= maxW / width; width = maxW; }
            if (height > maxH) { width *= maxH / height; height = maxH; }

            const canvas = document.createElement('canvas');
            canvas.width = width; canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);

            canvas.toBlob((blob) => {
              if (!blob || blob.size === 0) {
                resolve(file); // fallback
              } else if (blob.size > file.size) {
                resolve(file); // fallback if bigger
              } else {
                resolve(new File([blob], file.name, {type:'image/jpeg'}));
              }
            }, 'image/jpeg', quality);
          };
          img.onerror = () => resolve(file); // fallback
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // ðŸ”¹ Submit report
    reportForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      formMsg.textContent = '';

      const type = document.getElementById('type').value;
      const name = document.getElementById('itemName').value.trim();
      const description = document.getElementById('description').value.trim();
      const location = document.getElementById('location').value.trim();
      const date = document.getElementById('date').value;
      const contact = document.getElementById('contact').value.trim();
      const file = document.getElementById('photo').files[0];

      if (!name || !contact) {
        formMsg.textContent = 'Please enter item name and contact.';
        return;
      }

      // Step 1: create report instantly (no image yet)
      const newItemRef = db.ref('items').push();
      const data = { type, name, description, location, date, contact, imageUrl:"", createdAt: Date.now() };
      await newItemRef.set(data);

      // Step 2: local preview
      if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
          const preview = document.createElement("div");
          preview.classList.add("item");
          preview.innerHTML = `
            <h3>${type.toUpperCase()}: ${name}</h3>
            <img src="${ev.target.result}" alt="${name}" />
            <p>${description || ""}</p>
            <p><b>Contact:</b> ${contact}</p>
            <small>${location || ""} ${date || ""}</small>
            <em>Uploading image...</em>
          `;
          itemsContainer.prepend(preview);
        };
        reader.readAsDataURL(file);

        // Step 3: compress + upload
        formMsg.textContent = 'Uploading image in backgroundâ€¦';
        try {
          const fileToUpload = await compressIfNeeded(file);
          const path = 'images/' + Date.now() + '_' + fileToUpload.name.replace(/\s+/g,'_');
          const storageRef = storage.ref().child(path);
          const snap = await storageRef.put(fileToUpload);
          const url = await snap.ref.getDownloadURL();
          await newItemRef.update({ imageUrl: url });
        } catch(err) {
          console.error("Upload failed:", err);
        }
      }

      formMsg.textContent = 'Report submitted âœ…';
      reportForm.reset();
      setTimeout(()=>formMsg.textContent='',3000);
    });

    // ðŸ”¹ Realtime listener
    db.ref('items').on('child_added', snap => {
      const item = snap.val();
      const div = document.createElement('div');
      div.classList.add('item');
      div.innerHTML = `
        <h3>${item.type.toUpperCase()}: ${item.name}</h3>
        ${item.imageUrl ? `<img src="${item.imageUrl}" alt="${item.name}" />` : ""}
        <p>${item.description || ""}</p>
        <p><b>Contact:</b> ${item.contact}</p>
        <small>${item.location || ""} ${item.date || ""}</small>
      `;
      itemsContainer.prepend(div);
    });
  </script>
</body>
</html>
