<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Waste Management â€” Demo</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body{ font-family: system-ui, sans-serif; margin:0; padding:0; }
    header{ display:flex; justify-content:space-between; align-items:center; padding:10px 16px; background:#222; color:#fff }
    #role-switch button{ margin-left:8px; padding:6px 10px; border:none; border-radius:6px; background:#555; color:#fff; cursor:pointer; }
    #role-switch button.active{ background:#28a745; }
    #map{ height:60vh; }
    #info{ padding:12px }
    #stats{ font-weight:600; margin-bottom:8px }
    #alerts{ margin-top:12px; padding:10px; border:1px solid #ccc; background:#f9f9f9 }
    .alert{ padding:6px 0; border-bottom:1px solid #eee }
  </style>
</head>
<body>
  <header>
    <h1>Smart Waste Management â€” Demo</h1>
    <div id="role-switch">
      <button id="role-citizen">Citizen</button>
      <button id="role-collector">Collector</button>
    </div>
  </header>

  <main>
    <div id="map"></div>

    <section id="info">
      <div id="stats">Loading stats...</div>
      <div id="actions"><p>Click a bin on the map to interact.</p></div>
      <div id="alerts"><strong>Alerts:</strong><div id="alert-list"></div></div>
    </section>
  </main>

  <!-- FIREBASE CONFIG -->
  <script>
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyA6nAAc3sx9mkOapNSff7k1EFGkfbLN_o4",
      authDomain: "smart-bin-b826f.firebaseapp.com",
      databaseURL: "https://smart-bin-b826f-default-rtdb.firebaseio.com",
      projectId: "smart-bin-b826f",
      storageBucket: "smart-bin-b826f.firebasestorage.app",
      messagingSenderId: "339092553035",
      appId: "1:339092553035:web:9edfd5351f64d6cb563cce",
      measurementId: "G-HN2LD86VWN"
    };
  </script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    // Initialize Firebase
    firebase.initializeApp(FIREBASE_CONFIG);
    const db = firebase.database();

    let map;
    const markers = {};
    let role = 'citizen';

    // seed bins if database is empty
    function seedBins() {
      const sampleBins = {
        "bin1": { lat: -1.28333, lng: 36.81667, level: 0, status: "empty", lastUpdated: Date.now(), reportedBy:null },
        "bin2": { lat: -1.2921, lng: 36.8219, level: 40, status: "half", lastUpdated: Date.now(), reportedBy:null },
        "bin3": { lat: -1.3000, lng: 36.8200, level: 100, status: "full", lastUpdated: Date.now(), reportedBy:"citizenUser1" },
        "bin4": { lat: -1.2765, lng: 36.8172, level: 60, status: "half", lastUpdated: Date.now(), reportedBy:null },
        "bin5": { lat: -1.2890, lng: 36.8300, level: 100, status: "full", lastUpdated: Date.now(), reportedBy:"citizenUser2" }
      };
      db.ref("bins").set(sampleBins);
    }

    function initApp(){
      // default center Nairobi
      map = L.map('map').setView([-1.28333, 36.81667], 13);

      // OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // role buttons
      document.getElementById('role-citizen').onclick = ()=> setRole('citizen');
      document.getElementById('role-collector').onclick = ()=> setRole('collector');
      setRole('citizen');

      // check if bins exist, otherwise seed
      db.ref("bins").once("value").then(snap => {
        if(!snap.exists()) seedBins();
      });

      // listen to bins
      db.ref('bins').on('value', snap => {
        const bins = snap.val() || {};
        updateMarkers(bins);
        updateStats(bins);
      });
    }

    function setRole(newRole){
      role = newRole;
      document.getElementById('role-citizen').classList.toggle('active', role==='citizen');
      document.getElementById('role-collector').classList.toggle('active', role==='collector');
      renderInfo();
    }

    function updateMarkers(bins){
      for(const id in markers){
        if(!bins[id]){ map.removeLayer(markers[id]); delete markers[id]; }
      }
      for(const id in bins){
        const b = bins[id];
        if(markers[id]){
          markers[id].setLatLng([b.lat, b.lng]);
          markers[id].setIcon(iconForStatus(b.status));
        } else {
          const m = L.marker([b.lat, b.lng], { icon: iconForStatus(b.status) })
            .addTo(map)
            .on('click', ()=> onMarkerClick(id, b));
          markers[id] = m;
        }
      }
    }

    function iconForStatus(status){
      const color = status==='full' ? 'red' : status==='half' ? 'orange' : 'green';
      return L.divIcon({ className:'', html:`<div style="background:${color};width:20px;height:20px;border-radius:50%;"></div>` });
    }

    function onMarkerClick(id, bin){
      const actions = document.getElementById('actions');
      actions.innerHTML = `<h3>Bin ${id}</h3><p>Status: ${bin.status} (${bin.level}%)</p>`;
      if(role==='citizen'){
        const btn=document.createElement('button');
        btn.textContent='Report Full';
        btn.onclick=()=> reportFull(id);
        actions.appendChild(btn);
      } else {
        const btn=document.createElement('button');
        btn.textContent='Mark Collected (Reset)';
        btn.onclick=()=> resetBin(id, bin);
        actions.appendChild(btn);
      }
    }

    function reportFull(id){
      db.ref('bins/'+id).update({
        level:100,
        status:'full',
        lastUpdated:Date.now(),
        reportedBy:"citizenUser1"   // placeholder citizen
      });
      addAlert(`ðŸ“© Alert: Bin ${id} reported as FULL! Collector notified.`);
    }

    function resetBin(id, bin){
      db.ref('bins/'+id).update({
        level:0,
        status:'empty',
        lastUpdated:Date.now(),
        reportedBy:null
      });
      addAlert(`âœ… Bin ${id} has been emptied. Citizen who reported has been notified.`);
    }

    function updateStats(bins){
      const counts={full:0,half:0,empty:0};
      for(const id in bins){ counts[bins[id].status]++; }
      document.getElementById('stats').innerHTML = `Full: ${counts.full} | Half: ${counts.half} | Empty: ${counts.empty}`;
    }

    function renderInfo(){
      document.getElementById('actions').innerHTML = '<p>Click a bin on the map to interact.</p>';
    }

    function addAlert(msg){
      const container=document.getElementById('alert-list');
      const div=document.createElement('div');
      div.className='alert';
      div.textContent=msg;
      container.prepend(div);
    }

    window.onload = initApp;
  </script>
</body>
</html>
