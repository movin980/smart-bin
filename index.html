<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Campus Lost & Found</title>
  <link rel="stylesheet" href="https://unpkg.com/normalize.css/normalize.css" />
  <style>
    :root{
      --accent:#2b8aef;
      --card:#fff;
      --muted:#666;
      --bg:#f4f6fb;
    }
    body{ font-family: Inter, system-ui, -apple-system, Arial; background:var(--bg); margin:0; padding:18px; color:#111;}
    header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:18px;}
    h1{ margin:0; font-size:20px;}
    .container{ max-width:980px; margin:0 auto; }
    .btn{ background:var(--accent); color:#fff; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; }
    .btn.secondary{ background:#444; }
    .card{ background:var(--card); padding:12px; border-radius:10px; box-shadow:0 6px 18px rgba(20,20,40,0.06); }
    form label{ display:block; font-weight:600; margin-top:8px; font-size:13px; }
    form input, form textarea, form select {
      width:100%; padding:8px; border-radius:6px; border:1px solid #ddd; margin-top:6px; box-sizing:border-box;
    }
    .item-grid{ display:grid; grid-template-columns: repeat(auto-fill,minmax(240px,1fr)); gap:12px; }
    .item-card{ background:#fff; padding:10px; border-radius:10px; box-shadow:0 6px 14px rgba(10,10,30,0.05); display:flex; gap:10px; align-items:flex-start; }
    .thumb{ width:72px; height:72px; background:#eee; border-radius:8px; object-fit:cover; }
    .meta{ flex:1; }
    .badge{ display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; color:#fff; }
    .badge.lost{ background:#d9534f; }
    .badge.found{ background:#5cb85c; }
    .small-muted{ font-size:12px; color:#666; margin-top:6px; }
    .empty{ color:#888; padding:18px; text-align:center; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Campus Lost & Found — Demo</h1>
    </header>

    <!-- Report Form -->
    <div class="card">
      <h3>Report Lost or Found</h3>
      <form id="reportForm">
        <label>Type</label>
        <select id="type" required>
          <option value="lost">Lost</option>
          <option value="found">Found</option>
        </select>

        <label>Item Name</label>
        <input id="itemName" type="text" required placeholder="e.g., Black wallet" />

        <label>Description</label>
        <textarea id="description" placeholder="Any details: brand, marks, contents..."></textarea>

        <label>Contact (email or phone)</label>
        <input id="contact" type="text" required placeholder="john@example.com or +2547..." />

        <label>Photo (optional)</label>
        <input id="photo" type="file" accept="image/*" />

        <div style="margin-top:10px;">
          <button class="btn" type="submit">Submit Report</button>
        </div>
        <div id="formMsg" class="small-muted" style="margin-top:8px;"></div>
      </form>
    </div>

    <div style="height:12px"></div>

    <!-- Items -->
    <div class="card">
      <h3>Items</h3>
      <div id="itemsContainer" class="item-grid"></div>
      <div id="itemsEmpty" class="empty" style="display:none;">No items found.</div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyAXak-lN_WmRe0CbN0UkwcwxTfayIE5FA0",
      authDomain: "smartbin34.firebaseapp.com",
      databaseURL: "https://smartbin34-default-rtdb.firebaseio.com",
      projectId: "smartbin34",
      storageBucket: "smartbin34.appspot.com",
      messagingSenderId: "1098169082361",
      appId: "1:1098169082361:web:87ce799868d755b4f11d28",
      measurementId: "G-VEJY91T6CM"
    };

    firebase.initializeApp(FIREBASE_CONFIG);
    const db = firebase.database();
    const storage = firebase.storage();

    const reportForm = document.getElementById("reportForm");
    const itemsContainer = document.getElementById("itemsContainer");
    const itemsEmpty = document.getElementById("itemsEmpty");
    const formMsg = document.getElementById("formMsg");

    // Compress image before upload
    function compressImage(file, maxWidth, maxHeight, callback) {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = (event) => {
        const img = new Image();
        img.src = event.target.result;
        img.onload = () => {
          const canvas = document.createElement("canvas");
          let width = img.width;
          let height = img.height;

          if (width > height) {
            if (width > maxWidth) {
              height *= maxWidth / width;
              width = maxWidth;
            }
          } else {
            if (height > maxHeight) {
              width *= maxHeight / height;
              height = maxHeight;
            }
          }

          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, width, height);

          canvas.toBlob((blob) => {
            callback(blob);
          }, "image/jpeg", 0.7);
        };
      };
    }

    // Add item card to UI instantly
    function addItemToUI(item) {
      const card = document.createElement("div");
      card.className = "item-card";
      const img = document.createElement("img");
      img.className = "thumb";
      img.src = item.imageUrl || "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='72' height='72'><rect width='100%' height='100%' fill='%23eee'/></svg>";
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `
        <h4>${item.type.toUpperCase()}: ${item.name}</h4>
        <div>${item.description || ""}</div>
        <div class="small-muted">Contact: ${item.contact}</div>
        <div class="badge ${item.type === "lost" ? "lost" : "found"}">${item.type}</div>
      `;
      card.appendChild(img);
      card.appendChild(meta);
      itemsContainer.prepend(card);
      itemsEmpty.style.display = "none";
    }

    // Submit form
    reportForm.onsubmit = (e) => {
      e.preventDefault();
      formMsg.textContent = "Processing...";
      const type = document.getElementById("type").value;
      const name = document.getElementById("itemName").value.trim();
      const description = document.getElementById("description").value.trim();
      const contact = document.getElementById("contact").value.trim();
      const photoInput = document.getElementById("photo");
      const file = photoInput.files[0];

      if (!name || !contact) {
        formMsg.textContent = "Please enter item name and contact.";
        return;
      }

      const saveItem = (imageUrl) => {
        const newItemRef = db.ref("items").push();
        const data = { type, name, description, contact, imageUrl, createdAt: Date.now() };
        newItemRef.set(data).then(() => {
          formMsg.textContent = "Report submitted ✅";
          addItemToUI(data);
          reportForm.reset();
          setTimeout(() => (formMsg.textContent = ""), 3000);
        });
      };

      if (file) {
        compressImage(file, 800, 800, (compressedBlob) => {
          const path = "images/" + Date.now() + "_" + file.name.replace(/\s+/g, "_");
          const ref = storage.ref().child(path);
          const uploadTask = ref.put(compressedBlob);

          uploadTask.on("state_changed",
            (snap) => {
              const progress = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
              formMsg.textContent = `Uploading... ${progress}%`;
            },
            (err) => {
              console.error(err);
              formMsg.textContent = "Upload failed.";
            },
            () => {
              uploadTask.snapshot.ref.getDownloadURL().then((url) => {
                saveItem(url);
              });
            }
          );
        });
      } else {
        saveItem(null);
      }
    };

    // Subscribe to DB updates
    db.ref("items").on("value", (snap) => {
      itemsContainer.innerHTML = "";
      if (!snap.exists()) {
        itemsEmpty.style.display = "block";
        return;
      }
      itemsEmpty.style.display = "none";
      const items = snap.val();
      Object.values(items).forEach(addItemToUI);
    });
  </script>
</body>
</html>
